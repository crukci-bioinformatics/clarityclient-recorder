<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 2.0.0-M10 from src/site/markdown/usage.md at 2023-10-24
 | Rendered using Apache Maven Fluido Skin 2.0.0-M6
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 2.0.0-M10" />
    <title>CRUK-CI Genologics API Client Recorder – Setting up the Record and Playback Wrappers</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-2.0.0-M6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script src="./js/apache-maven-fluido-2.0.0-M6.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"></div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2023-10-24<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 2.31.ee8.6</li>
        <li class="pull-right"><a href="../clarityclient" title="Clarity Java Client">Clarity Java Client</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">User Guide</li>
    <li><a href="installing.html" title="Installation"><span class="none"></span>Installation</a></li>
    <li class="active"><a><span class="none"></span>Usage</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<section><section>
<h2>Setting up the Record and Playback Wrappers</h2>
<p>The documentation for the core Clarity Java Client can be found at
<a href="https://crukci-bioinformatics.github.io/clarityclient" class="externalLink">https://crukci-bioinformatics.github.io/clarityclient</a></p><section>
<h3>Spring Configuration</h3>
<p>The main Spring configuration file for the Clarity client is:</p>

<div class="verbatim">
<pre><code>/org/cruk/clarity/api/clarity-client-context.xml
</code></pre></div>
<p>You will need to add one of the wrappers to your application context path
to activate the wrapper. For recording messages from a server, also include:</p>

<div class="verbatim">
<pre><code>/org/cruk/clarity/api/clarity-record-context.xml
</code></pre></div>
<p>To use prerecorded messages, include:</p>

<div class="verbatim">
<pre><code>/org/cruk/clarity/api/clarity-playback-context.xml
</code></pre></div>
<p>Add the appropriate file to your Spring application context path. If you
wish to use the caching feature too, you'll also need to add:</p>

<div class="verbatim">
<pre><code>/org/cruk/clarity/api/clarity-cache-context.xml
</code></pre></div>
<p><code>clarity-client-context.xml</code> and <code>clarity-cache-context.xml</code>
are provided in the main client's JAR file.
<code>clarity-record-context.xml</code> and <code>clarity-playback-context.xml</code> are
provides in the recorder's JAR file.</p>
<p>It is recommended to use the Spring Test module (<code>spring-test</code>). Our tests
are written for JUnit 5, and for these there are some convenience Spring
configuration classes provided to help with this. A test class needs to be annotated
to use the Spring test system and initialised with a recording or playback configuration:</p>

<div class="verbatim">
<pre><code class="language-Java">@SpringJUnitConfig(locations = {
    &quot;classpath:/org/cruk/clarity/api/clarity-client-context.xml&quot;,
    &quot;classpath:/org/cruk/clarity/api/clarity-playback-context.xml&quot;
})
</code></pre></div>
<p>Replace <code>clarity-playback-context.xml</code> with <code>clarity-record-context.xml</code>
for recording. Typically one may use the recording class to get the actual results from
a real Clarity server, then switch to the playback configuration to run the tests
from the recorded files. Don't forget to check the recorded files into source control.</p>
<p>Test classes annotated as above become Spring beans themselves, and as such can
have dependencies injected. For example:</p>

<div class="verbatim">
<pre><code class="language-Java">@Autowired
ClarityAPI api;
</code></pre></div></section><section>
<h3>Setting the Message Directory</h3>
<p>The record and playback wrappers around the Clarity client need no additional
configuration beyond what is supplied in the Spring files. The one property that
the user might want to change is the directory the server's messages are written
to, or the pretend server reads from.</p>
<p>By default, both the recording and playback aspects write and read into a
directory <code>serverexchanges</code> in the current working directory. This can be
configured by setting the <code>messageDirectory</code> property in Spring configuration,
or injecting the aspect into the unit test class code and setting the property:</p>

<div class="verbatim">
<pre><code class="language-Java">@SpringJUnitConfig(locations = {
    &quot;classpath:/org/cruk/clarity/api/clarity-client-context.xml&quot;,
    &quot;classpath:/org/cruk/clarity/api/clarity-playback-context.xml&quot;
})
public class MyUnitTest
{
    @Autowired(required = false)
    ClarityAPIPlaybackAspect playbackAspect;

    File recordedMessageDirectory = new File(&quot;src/test/servermessages&quot;);

    @PostConstruct
    public void setPlaybackDirectory()
    {
        if (playbackAspect != null)
        {
            playbackAspect.setMessageDirectory(recordedMessageDirectory);
        }
    }
}
</code></pre></div>
<p>This mechanism works for recording too. Just inject <code>ClarityAPIRecordingAspect</code>
instead of <code>ClarityAPIPlaybackAspect</code>. This directory is not automatically created,
so when recording make sure that it exists before communicating with the server.</p></section><section>
<h3>Setting the Updates Directory during Playback</h3>
<p>The playback wrapper returns results from previously recorded calls to
the API's load, retrieve, load, find and list methods, finding the matching
file in the messages directory, unmarshalling its XML and returning the object
as the real API would. It quietly ignores create, delete and upload methods.
Update calls can either by also quietly ignored, or they can be recorded
in a separate directory. If one sets the <code>updatesDirectory</code>, any update calls
will have the new versions of the entities written here with an incrementing
index number.</p>
<p>For example, a sample with the id <code>S1234</code> has been read from the server
and is recorded in the messages directory in a file <code>Sample-S1234.xml</code>.
Each call to the API's <code>update</code> or <code>updateAll</code> methods for this sample will
result in a file being added to the updates directory. The first will be
<code>Sample-S1234.000.xml</code>, a second update will write <code>Sample-S1234.001.xml</code>
and so forth. These updates can be checked as part of unit tests.</p>
<p>Update calls are ignored unless the <code>updatesDirectory</code> is set, either in
Spring configuration or in code. Following from the example above, the latter
would be done thus:</p>

<div class="verbatim">
<pre><code class="language-Java">@PostConstruct
public void setPlaybackDirectory()
{
    if (playbackAspect != null)
    {
        playbackAspect.setMessageDirectory(recordedMessageDirectory);
        playbackAspect.setUpdatesDirectory(new File(&quot;target/updates&quot;));
    }
}
</code></pre></div></section></section></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>©      2013–2023
<a href="https://www.cruk.cam.ac.uk/">Cancer Research UK Cambridge Institute</a>
</p>
        </div>
      </div>
    </footer>
<script>
  if(anchors) {
    anchors.add();
  }
</script>
  </body>
</html>
